##
## -----------------------------------
## | S P E E D T E S T - D O C K E R |
## -----------------------------------
##
## Container based media tools configuration
##
## -- DO NOT EDIT THIS FILE --
##
## Configuration items for this file are taken from the .env file
##
## Have docker-compose.yml and .env in the same directory to launch the stack

version: '3'

######################
# SERVICES TO LAUNCH #
######################

services:
  # ----------------------------------------
  # InfluxDB
  # Time Series Database
  # ----------------------------------------
  influxdb:
    image: influxdb:1.8.4
    container_name: influxdb
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-file: '${LOG_FILE_NUM}'
        max-size: '${LOG_FILE_SIZE}'
    networks:
      - internal
    expose:
      - 8086
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
      - INFLUXDB_DB=speedtest;
    volumes:
      - '${BASE_DOCKER_PATH}/influxdb:/var/lib/influxdb'

  # ----------------------------------------
  # Chronograf
  # Dashboard Tool for Speedtest
  # ----------------------------------------
  chronograf:
    image: chronograf
    container_name: chronograf
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-file: '${LOG_FILE_NUM}'
        max-size: '${LOG_FILE_SIZE}'
    networks:
      - web
      - internal
    expose:
      - 8888
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - '${BASE_DOCKER_PATH}/chronograf:/var/lib/chronograf'
    command:
      - chronograf
      - --influxdb-url=http://influxdb:8086
    depends_on:
      - influxdb

  # ----------------------------------------
  # Speedtest
  # Speedtest-CLI and Post to InfluxDB
  # ----------------------------------------
  speedtest:
    image: phikai/speedtest
    container_name: speedtest
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-file: '${LOG_FILE_NUM}'
        max-size: '${LOG_FILE_SIZE}'
    networks:
      - internal
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
      - TEST_INTERVAL=${SPEEDTEST_INTERVAL}
    depends_on:
      - influxdb

########################
# GLOBAL CONFIGURATION #
########################

networks:
  internal:
  web:
